{"version":3,"names":["contentCache","Map","fetchContent","locale","app","config","getConfig","featureToggles","env","isShopEnabled","isShopToggleActive","Application","shop","naviContentPromise","fetchNaviContent","CONTENT_URL","shopContentPromise","fetchShopContent","SHOP_CONTENT_URL","Promise","resolve","allSettled","_b","_c","sent","naviContentResult","shopContentResult","status","reason","naviContent","modifyShopItemDependingOnMarket","value","shopContent","Object","assign","children","menuItems","_a","additionalContent","availableLocales","availableLocalesOnlyForShop","contentUrl","splitLocale","country","language","cacheKey","constructCacheKey","cachedContent","get","undefined","fetch","concat","headers","data","NaviError","NaviErrorTypes","NO_RESULTS","ok","GENERAL","json","content","set","toLowerCase","constructFlagURL","footerAssetsUrl","flag","includes","isCountryInOneOfRegions","split","getFlagURL","flagURL","res"],"sources":["src/services/content-service.ts"],"sourcesContent":["import { Content, ShopContentResponse } from '../entities/content';\nimport { isCountryInOneOfRegions, splitLocale } from '../entities/locale';\nimport { Application, ApplicationType } from '../utility/constants/app';\nimport { constructCacheKey, getConfig } from '../utility/helper';\nimport { modifyShopItemDependingOnMarket } from '../utility/helpers/shop-helper';\nimport { NaviError, NaviErrorTypes } from '../utility/navi-error';\nimport featureToggles from './feature-toggles';\n\nexport const contentCache = new Map<string, Content>();\n\nexport async function fetchContent(locale: string, app?: ApplicationType): Promise<Content> {\n  const config = getConfig(featureToggles.env);\n\n  const isShopEnabled = featureToggles.isShopToggleActive() && app === Application.shop;\n\n  const naviContentPromise = fetchNaviContent(config.CONTENT_URL, locale);\n  const shopContentPromise = isShopEnabled ? fetchShopContent(config.SHOP_CONTENT_URL, locale) : Promise.resolve(null);\n\n  const [naviContentResult, shopContentResult] = await Promise.allSettled([naviContentPromise, shopContentPromise]);\n\n  if (naviContentResult.status === 'rejected') {\n    throw naviContentResult.reason;\n  }\n\n  const naviContent = modifyShopItemDependingOnMarket(locale, app, naviContentResult.value);\n\n  const shopContent = shopContentResult.status === 'fulfilled' ? shopContentResult.value : null;\n\n  if (shopContent === null || naviContent.shop === null) {\n    return naviContent;\n  }\n\n  return {\n    ...naviContent,\n    shop: {\n      ...naviContent.shop,\n      children: shopContent.menuItems || naviContent.shop?.children || [],\n      additionalContent: shopContent.additionalContent,\n      availableLocales: naviContent.shop.availableLocales,\n      availableLocalesOnlyForShop: naviContent.shop.availableLocalesOnlyForShop\n    }\n  };\n}\n\nasync function fetchNaviContent(contentUrl: string, locale: string): Promise<Content> {\n  const { country, language } = splitLocale(locale);\n\n  const cacheKey = constructCacheKey(contentUrl, locale);\n\n  const cachedContent = contentCache.get(cacheKey);\n  if (cachedContent !== undefined) {\n    return cachedContent;\n  }\n\n  const data = await fetch(`${contentUrl}/${`${language}-${country}`}.json`, {\n    headers: {\n      'Cache-Control': 'no-cache',\n      'Content-Type': 'application/json'\n    }\n  });\n\n  if (data.status === 404) {\n    throw new NaviError(`No content for locale ${locale} found`, NaviErrorTypes.NO_RESULTS);\n  }\n\n  if (!data.ok) {\n    throw new NaviError(`Could not get content for locale ${locale}`, NaviErrorTypes.GENERAL);\n  }\n\n  const content = await data.json();\n\n  contentCache.set(cacheKey, content);\n\n  return content;\n}\n\nasync function fetchShopContent(contentUrl: string, locale: string): Promise<ShopContentResponse> {\n  const { country, language } = splitLocale(locale);\n\n  const data = await fetch(`${contentUrl}/${country.toLowerCase()}/${`${language}-${country}`}/navigation`, {\n    headers: {\n      'Content-Type': 'application/json',\n      'x-vercel-protection-bypass': 'SHOP_CONTENT_KEY'\n    }\n  });\n\n  if (data.status === 404) {\n    throw new NaviError(`No shop content for locale ${locale} found`, NaviErrorTypes.NO_RESULTS);\n  }\n\n  if (!data.ok) {\n    throw new NaviError(`Could not get shop content for locale ${locale}`, NaviErrorTypes.GENERAL);\n  }\n\n  return data.json();\n}\n\nexport function constructFlagURL(footerAssetsUrl: string, locale: string): string {\n  const { country } = splitLocale(locale);\n\n  let flag = country;\n  if (flag.includes('-') && !isCountryInOneOfRegions(flag)) {\n    flag = country.split('-')[0];\n  }\n\n  return `${footerAssetsUrl}/flags/${flag}.svg`;\n}\n\nexport async function getFlagURL(footerAssetsUrl: string, locale: string): Promise<string> {\n  try {\n    const flagURL = constructFlagURL(footerAssetsUrl, locale);\n\n    const res = await fetch(flagURL);\n\n    // Only set flagURL if flag actually exists\n    if (res.ok) {\n      return flagURL;\n    }\n  } catch (err) {\n    // ignore error\n  }\n\n  return '';\n}\n"],"mappings":"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"}